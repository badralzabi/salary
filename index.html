<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المبيعات الذكي - SalesPro AI</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .sidebar {
            transition: all 0.3s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #auth-loading {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,1);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        
        .nav-item.active {
            background-color: #e0e7ff;
            color: #4f46e5;
            font-weight: 700;
        }

        /* تأثير النبض للزر السحري */
        .magic-btn:active {
            transform: scale(0.95);
        }
        .magic-loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }


        @media (max-width: 640px) {
            th, td {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                font-size: 0.75rem !important; /* text-xs */
            }
            .p-6 {
                padding: 1rem !important;
            }
            .text-2xl {
                font-size: 1.25rem !important;
            }
        }

        #printable-report {
            display: none;
        }

        @media print {
            body > *:not(#printable-report) {
                display: none !important;
            }
            
            #printable-report {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background: white;
                z-index: 9999;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white;
                height: auto;
                overflow: visible;
            }

            .page-break {
                page-break-after: always;
            }
            
            @page {
                margin: 0;
                size: A4;
            }
        }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen overflow-hidden">

    <div id="auth-loading">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
            <p class="text-indigo-600 font-bold">جاري الاتصال بالنظام...</p>
        </div>
    </div>

    <div id="printable-report" class="bg-white min-h-screen">
    </div>

    <section id="login-view" class="h-full w-full flex items-center justify-center bg-gray-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden flex flex-col border border-gray-100 fade-in">
            <div class="w-full p-8 md:p-10">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-50 text-indigo-600 text-3xl mb-4">
                        <i class="fa-solid fa-chart-pie"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800" id="authTitle">تسجيل الدخول</h2>
                    <p class="text-gray-500 text-sm mt-2" id="authSubtitle">مرحباً بك مجدداً في نظام SalesPro</p>
                </div>

                <form id="authForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                        <div class="relative">
                            <i class="fa-regular fa-envelope absolute right-3 top-3 text-gray-400"></i>
                            <input type="email" id="authEmail" required class="w-full pl-4 pr-10 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="example@company.com">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                        <div class="relative">
                            <i class="fa-solid fa-lock absolute right-3 top-3 text-gray-400"></i>
                            <input type="password" id="authPassword" required class="w-full pl-4 pr-10 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="••••••••">
                        </div>
                    </div>

                    <div id="authError" class="text-red-500 text-sm hidden bg-red-50 p-2 rounded text-center">
                        خطأ في البيانات
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-indigo-200">
                        دخول
                    </button>
                </form>

                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">بأستخدامك نظامنا فأنت توافق على شروط الاستخدام </span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="text-center mt-2">
                    <p class="text-sm text-gray-600">
                        <button type="button" id="toggleAuthMode" class="text-indigo-600 font-bold hover:underline">
                            
                        </button>
                    </p>
                </div>

                <div class="text-center mt-4">
                    <button type="button" id="demoLoginBtn" class="text-gray-400 text-xs hover:text-indigo-600 transition">
                        
                    </button>
                </div>

                <div class="mt-6 border-t border-gray-100 pt-5">
                    <a href="who_by/index.html" class="block text-center text-indigo-600 font-bold text-sm hover:underline mb-3 transition-colors">
                        <i class="fa-solid fa-circle-question ml-1"></i> كيف تشترك في نظامنا؟
                    </a>
                    
                    <div class="flex justify-center gap-3 text-xs text-gray-400">
                        <a href="privacy_policy/index.html" class="hover:text-gray-600 hover:underline transition">سياسة الخصوصية</a>
                        <span class="text-gray-300">|</span>
                        <a href="terms_use/index.html" class="hover:text-gray-600 hover:underline transition">شروط الاستخدام</a>
                    </div>
                </div>
                </div>
        </div>
    </section>

    <div id="app-dashboard" class="h-full flex overflow-hidden hidden opacity-0 transition-opacity duration-500">
        <aside id="sidebar" class="sidebar bg-white w-64 h-full shadow-lg flex flex-col fixed inset-y-0 right-0 z-50 transform translate-x-full md:translate-x-0 md:relative hidden md:flex border-l border-gray-100">
            <div class="p-6 flex items-center justify-center border-b border-gray-100">
                <div class="flex items-center gap-3 text-indigo-600 font-bold text-2xl">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span id="storeNameSidebar">SalesPro</span>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
                <p class="text-xs font-semibold text-gray-400 px-2 mb-2">القائمة الرئيسية</p>
                <a href="#" onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-house"></i>
                    <span>لوحة التحكم</span>
                </a>
                <a href="#" onclick="switchView('products')" id="nav-products" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-box-open"></i>
                    <span>المنتجات</span>
                </a>
                <a href="#" onclick="switchView('orders')" id="nav-orders" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span>الطلبات</span>
                </a>
                <a href="#" onclick="switchView('customers')" id="nav-customers" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-users"></i>
                    <span>العملاء</span>
                </a>
                <a href="#" onclick="switchView('expenses')" id="nav-expenses" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-receipt"></i>
                    <span>المصروفات</span>
                </a>
                <a href="#" onclick="switchView('reports')" id="nav-reports" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                    <span>التقارير المالية</span>
                </a>
                <p class="text-xs font-semibold text-gray-400 px-2 mt-6 mb-2">الإعدادات</p>
                <a href="#" onclick="switchView('settings')" id="nav-settings" class="nav-item flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-indigo-600 rounded-xl transition-colors">
                    <i class="fa-solid fa-gear"></i>
                    <span>الإعدادات العامة</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 cursor-pointer transition">
                    <img src="" id="userAvatar" alt="User" class="w-10 h-10 rounded-full">
                    <div class="flex-1 overflow-hidden">
                        <h4 class="text-sm font-bold text-gray-800 truncate" id="userNameDisplay">المستخدم</h4>
                        <p class="text-xs text-gray-500 truncate" id="userEmailDisplay">...</p>
                    </div>
                    <button onclick="logoutUser()" class="text-gray-400 hover:text-red-500 transition" title="تسجيل الخروج">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass-effect"></div>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50/50">

            <header class="h-auto py-3 md:py-0 md:h-20 bg-white border-b border-gray-100 flex flex-col md:flex-row md:items-center justify-between px-4 lg:px-10 z-30 flex-shrink-0 gap-3">
                <div class="flex items-center justify-between w-full md:w-auto">
                    <div class="flex items-center gap-4">
                        <button id="sidebarToggle" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden">
                            <i class="fa-solid fa-bars text-xl"></i>
                        </button>
                        <h2 class="text-xl font-bold text-gray-800" id="pageTitle">نظرة عامة</h2>
                    </div>
                    

                    <div class="flex items-center gap-2 md:hidden">
                        <button onclick="openOrderModal()" class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-100 hover:bg-indigo-100 px-3 py-2 rounded-lg text-xs font-bold transition">
                            <i class="fa-solid fa-plus"></i>
                            <span>جديد</span>
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row items-stretch md:items-center gap-2 md:gap-4 w-full md:w-auto">
                    <button onclick="generateDashboardInsights()" id="aiAnalysisBtn" class="flex justify-center md:hidden items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md shadow-indigo-200 w-full">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <span>تحليل ذكي</span>
                    </button>

                    <div class="flex items-center bg-gray-100 rounded-lg px-2 py-2 w-full md:w-96 border border-gray-200 focus-within:border-indigo-400 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                        <select id="searchScope" class="bg-transparent border-none outline-none text-xs font-bold text-gray-600 ml-2 cursor-pointer focus:ring-0">
                            <option value="current">الحالي (عام)</option>
                            <option value="orders">في الطلبات</option>
                            <option value="products">في المنتجات</option>
                            <option value="customers">في العملاء</option>
                        </select>
                        <div class="h-5 w-px bg-gray-300 mx-2"></div>
                        <i class="fa-solid fa-magnifying-glass text-gray-400 ml-2"></i>
                        <input type="text" id="searchInput" placeholder="بحث..." class="bg-transparent border-none outline-none text-sm w-full font-medium text-gray-700 placeholder-gray-400">
                    </div>


                    <div class="hidden md:flex items-center gap-2">
                         <button onclick="generateDashboardInsights()" class="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md shadow-indigo-200">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            <span class="hidden lg:inline">تحليل ذكي</span>
                        </button>

                        <button onclick="openOrderModal()" class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-100 hover:bg-indigo-100 px-4 py-2 rounded-lg text-sm font-bold transition">
                            <i class="fa-solid fa-plus"></i>
                            <span>طلب جديد</span>
                        </button>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 lg:p-10 scroll-smooth relative">
                
                <div id="view-dashboard" class="view-section fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-sm text-gray-500 font-semibold mb-1">إجمالي المبيعات</p><h3 class="text-2xl font-bold text-gray-800" id="totalSales">$0</h3></div>
                                <div class="p-3 bg-green-50 text-green-600 rounded-xl"><i class="fa-solid fa-dollar-sign text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-sm text-gray-500 font-semibold mb-1">أرباح البضاعة</p><h3 class="text-2xl font-bold text-indigo-600" id="grossProfits">$0</h3></div>
                                <div class="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><i class="fa-solid fa-boxes-stacked text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-sm text-gray-500 font-semibold mb-1">إجمالي المصاريف</p><h3 class="text-2xl font-bold text-red-600" id="totalExpenses">$0</h3></div>
                                <div class="p-3 bg-red-50 text-red-600 rounded-xl"><i class="fa-solid fa-money-bill-transfer text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-sm text-gray-500 font-semibold mb-1">العملاء</p><h3 class="text-2xl font-bold text-gray-800" id="totalCustomers">0</h3></div>
                                <div class="p-3 bg-purple-50 text-purple-600 rounded-xl"><i class="fa-solid fa-user-group text-xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition ring-2 ring-orange-100">
                            <div class="flex justify-between items-start mb-4">
                                <div><p class="text-sm text-orange-600 font-bold mb-1">صافي الربح النهائي</p><h3 class="text-2xl font-bold text-gray-800" id="totalProfits">$0</h3></div>
                                <div class="p-3 bg-orange-50 text-orange-600 rounded-xl"><i class="fa-solid fa-wallet text-xl"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg text-gray-800 mb-6">تحليل المبيعات</h3>
                            <div class="relative h-64 w-full"><canvas id="salesChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg text-gray-800 mb-6">الأكثر مبيعاً</h3>
                            <div class="space-y-4" id="topProductsContainer"></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-8">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-gray-800">آخر الطلبات</h3>
                            <button onclick="switchView('orders')" class="text-sm text-indigo-600 font-bold hover:text-indigo-800">عرض الكل</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right min-w-[600px]">
                                <thead class="bg-gray-50 text-gray-500 font-medium">
                                    <tr>
                                        <th class="px-3 sm:px-6 py-4">رقم الطلب</th>
                                        <th class="px-3 sm:px-6 py-4">العميل</th>
                                        <th class="px-3 sm:px-6 py-4">رقم الهاتف</th> <th class="px-3 sm:px-6 py-4 w-1/3">المنتج (الوصف)</th>
                                        <th class="px-3 sm:px-6 py-4">الكمية</th>
                                        <th class="px-3 sm:px-6 py-4">التاريخ</th>
                                        <th class="px-3 sm:px-6 py-4">المبلغ</th>
                                        <th class="px-3 sm:px-6 py-4">الحالة</th>
                                        <th class="px-3 sm:px-6 py-4">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="dashboardOrdersTableBody"></tbody>
                            </table>
                            <div id="noDataMessage" class="hidden text-center py-8 text-gray-400">لا توجد طلبات لعرضها حالياً. ابدأ بإضافة طلب جديد!</div>
                        </div>
                    </div>
                </div>

                <div id="view-products" class="view-section hidden fade-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                         <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                             <h3 class="font-bold text-lg text-gray-800">إدارة المنتجات</h3>
                             <button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700">منتج جديد +</button>
                         </div>
                         <div class="overflow-x-auto">
                             <table class="w-full text-sm text-right min-w-[700px]">
                                 <thead class="bg-gray-50 text-gray-500 font-medium">
                                     <tr>
                                         <th class="px-3 sm:px-6 py-4">المنتج</th>
                                         <th class="px-3 sm:px-6 py-4">الوصف</th>
                                         <th class="px-3 sm:px-6 py-4">التصنيف</th>
                                         <th class="px-3 sm:px-6 py-4">سعر البيع</th>
                                         <th class="px-3 sm:px-6 py-4">التكلفة</th>
                                         <th class="px-3 sm:px-6 py-4">الربح (للقطعة)</th> <th class="px-3 sm:px-6 py-4">المخزون</th>
                                         <th class="px-3 sm:px-6 py-4">الحالة</th>
                                         <th class="px-3 sm:px-6 py-4">إجراء</th>
                                     </tr>
                                 </thead>
                                 <tbody id="productsTableBody"></tbody>
                             </table>
                         </div>
                    </div>
                </div>

                <div id="view-expenses" class="view-section hidden fade-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-gray-800">إدارة المصروفات التشغيلية</h3>
                            <button onclick="openExpenseModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-red-700">إضافة مصروف +</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-50 text-gray-500 font-medium">
                                    <tr>
                                        <th class="px-6 py-4">نوع المصروف</th>
                                        <th class="px-6 py-4">القيمة</th>
                                        <th class="px-6 py-4">التاريخ</th>
                                        <th class="px-6 py-4">ملاحظات</th>
                                        <th class="px-6 py-4">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody id="expensesTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="view-orders" class="view-section hidden fade-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between"><h3 class="font-bold">جميع الطلبات</h3></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right min-w-[700px]">
                                <thead class="bg-gray-50 text-gray-500 font-medium">
                                        <tr>
                                            <th class="px-3 sm:px-6 py-4">رقم الطلب</th>
                                            <th class="px-3 sm:px-6 py-4">العميل</th>
                                            <th class="px-3 sm:px-6 py-4">رقم الهاتف</th> <th class="px-3 sm:px-6 py-4 w-1/3">المنتج & الوصف</th> 
                                            <th class="px-3 sm:px-6 py-4">الكمية</th>
                                            <th class="px-3 sm:px-6 py-4">التاريخ</th>
                                            <th class="px-3 sm:px-6 py-4">المبلغ</th>
                                            <th class="px-3 sm:px-6 py-4">الحالة</th>
                                            <th class="px-3 sm:px-6 py-4">إجراء</th>
                                        </tr>
                                    </thead>
                                <tbody id="allOrdersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="view-customers" class="view-section hidden fade-in">
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="customersGrid"></div>
                </div>
                
                <div id="view-reports" class="view-section hidden fade-in">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">التقارير المالية</h3>
                        
                        <div class="max-w-xl mx-auto space-y-6">
                            <div class="flex flex-wrap gap-2 sm:gap-4 justify-center bg-gray-50 p-2 rounded-xl">
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200">
                                    <input type="radio" name="reportType" value="day" checked onchange="toggleReportInputs()" class="text-indigo-600">
                                    <span>يوم محدد</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200">
                                    <input type="radio" name="reportType" value="range" onchange="toggleReportInputs()" class="text-indigo-600">
                                    <span>فترة زمنية</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200">
                                    <input type="radio" name="reportType" value="all" onchange="toggleReportInputs()" class="text-indigo-600">
                                    <span>كل الوقت</span>
                                </label>
                            </div>

                            <div id="reportDateInputs" class="text-center">
                                <div id="dayInputGroup">
                                    <label class="block text-sm text-gray-500 mb-1">اختر التاريخ</label>
                                    <input type="date" id="reportDay" class="px-4 py-2 border rounded-lg w-full max-w-xs">
                                </div>
                                <div id="rangeInputGroup" class="hidden flex gap-2 justify-center">
                                    <div>
                                        <label class="block text-sm text-gray-500 mb-1">من</label>
                                        <input type="date" id="reportFrom" class="px-4 py-2 border rounded-lg w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-500 mb-1">إلى</label>
                                        <input type="date" id="reportTo" class="px-4 py-2 border rounded-lg w-full">
                                    </div>
                                </div>
                            </div>

                            <button onclick="generatePDF()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-file-pdf text-xl"></i>
                                <span>طباعة تقرير المبيعات والأرباح (PDF)</span>
                            </button>
                            <p class="text-center text-xs text-gray-400">سيتم تضمين المصاريف وصافي الأرباح بدقة في التقرير</p>
                        </div>
                    </div>
                </div>

                <div id="view-settings" class="view-section hidden fade-in">
                    <div class="max-w-2xl bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mx-auto">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">الإعدادات العامة</h3>
                        <form id="settingsForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم المتجر</label>
                                <input type="text" id="storeNameInput" value="SalesPro Store" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">العملة الأساسية</label>
                                <select id="currencySelect" class="w-full px-4 py-2 border rounded-lg outline-none bg-gray-50">
                                    <option value="JOD">الدينار الأردني (JOD)</option>
                                    <option value="USD">الدولار الأمريكي (USD)</option>
                                    <option value="SYP">الليرة السورية (SYP)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">سيتم تحديث أسعار المنتجات والتقارير تلقائياً بناءً على العملة المختارة.</p>
                            </div>

                            <div class="flex items-center gap-2 pt-2">
                                 <input type="checkbox" id="darkMode" class="w-4 h-4 text-indigo-600 rounded">
                                 <label for="darkMode" class="text-sm text-gray-700">تفعيل الوضع الليلي (قريباً)</label>
                            </div>

                            <div class="pt-4 text-left border-t">
                                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition shadow">
                                    حفظ الإعدادات
                                </button>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-gray-100">
                                <h4 class="text-red-600 font-bold mb-2">منطقة الخطر</h4>
                                <p class="text-xs text-gray-500 mb-3">هذا الإجراء سيقوم بحذف جميع المنتجات والطلبات والعملاء نهائياً. لا يمكن التراجع عنه.</p>
                                <button type="button" onclick="wipeAllData()" class="w-full bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white py-2 rounded-xl font-bold transition">
                                    <i class="fa-solid fa-trash-can ml-2"></i> تصفير النظام بالكامل
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <div id="addOrderModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeOrderModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl w-full max-w-md p-6 scale-95 transition-transform max-h-[90vh] overflow-y-auto" id="orderModalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="orderModalTitle">إضافة طلب جديد</h3>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-red-500 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <form id="orderForm" class="space-y-4">
                <input type="hidden" id="editingOrderId">
                <input type="text" id="customerName" required placeholder="اسم العميل" class="w-full px-4 py-2 border rounded-lg">
                
                <div class="flex gap-2">
                    <input type="email" id="customerEmail" placeholder="البريد الإلكتروني للعميل" class="w-1/2 px-4 py-2 border rounded-lg text-sm">
                    <input type="tel" id="customerPhone" placeholder="رقم الهاتف" class="w-1/2 px-4 py-2 border rounded-lg text-sm">
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">المنتج</label>
                    <select id="productNameSelect" class="w-full px-4 py-2 border rounded-lg">
                        </select>
                    <div id="selectedProductDesc" class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded hidden"></div>
                </div>

                <div class="flex gap-2 items-center">
                    <div class="w-1/3">
                        <label class="block text-xs text-gray-500 mb-1">الكمية</label>
                        <input type="number" id="orderQuantity" required min="1" value="1" placeholder="العدد" class="w-full px-4 py-2 border rounded-lg text-center font-bold text-gray-700">
                    </div>
                    <div class="w-2/3">
                         <label class="block text-xs text-gray-500 mb-1">المبلغ الإجمالي</label>
                        <input type="number" id="orderAmount" required placeholder="الإجمالي" class="w-full px-4 py-2 border rounded-lg bg-gray-50 cursor-not-allowed" readonly>
                    </div>
                </div>

                <div class="flex gap-2">
                      <div class="w-1/2">
                          <label class="block text-xs text-gray-500 mb-1">حالة الطلب</label>
                        <select id="orderStatus" class="w-full px-4 py-2 border rounded-lg">
                            <option value="completed">مكتمل</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="cancelled">ملغي</option>
                        </select>
                      </div>
                      <div class="w-1/2">
                        <label class="block text-xs text-gray-500 mb-1">تاريخ الطلب</label>
                        <input type="date" id="orderDate" required class="w-full px-4 py-2 border rounded-lg">
                      </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs text-gray-500">ملاحظات الطلب</label>
                        <button type="button" onclick="generateOrderNoteAI()" class="magic-btn text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> اقتراح ملاحظة
                        </button>
                    </div>
                    <textarea id="orderDescription" placeholder="ملاحظات إضافية على الطلب (اختياري)" class="w-full px-4 py-2 border rounded-lg h-16"></textarea>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">حفظ الطلب</button>
            </form>
        </div>
    </div>

    <div id="addProductModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeProductModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl w-full max-w-md p-6 scale-95 transition-transform max-h-[90vh] overflow-y-auto" id="productModalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="productModalTitle">إضافة منتج جديد</h3>
                <button onclick="closeProductModal()" class="text-gray-400 hover:text-red-500 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="editingProductId">
                <input type="text" id="newProdName" required placeholder="اسم المنتج" class="w-full px-4 py-2 border rounded-lg">
                
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs text-gray-500">الوصف</label>
                        <button type="button" onclick="generateProductDescAI()" class="magic-btn text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> توليد وصف تلقائي
                        </button>
                    </div>
                    <textarea id="newProdDesc" placeholder="وصف المنتج (المواصفات الفنية، الألوان، المميزات) - سيظهر في التقرير" class="w-full px-4 py-2 border rounded-lg h-20 bg-gray-50 focus:bg-white transition"></textarea>
                </div>
                
                <input type="text" id="newProdCategory" required placeholder="التصنيف (مثال: إلكترونيات)" class="w-full px-4 py-2 border rounded-lg">
                
                <div class="flex gap-2">
                    <input type="number" id="newProdPrice" required placeholder="سعر البيع للقطعة" class="w-1/2 px-4 py-2 border rounded-lg">
                    <input type="number" id="newProdCost" required placeholder="سعر التكلفة (للهامش)" class="w-1/2 px-4 py-2 border rounded-lg">
                </div>
                <input type="number" id="newProdStock" required placeholder="المخزون المتوفر" class="w-full px-4 py-2 border rounded-lg">
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">إضافة المنتج</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl w-full max-w-md p-6 scale-95 transition-transform shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-600" id="expenseModalTitle">إضافة مصروف جديد</h3>
                <button onclick="closeExpenseModal()" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form id="expenseForm" class="space-y-4">
                <input type="hidden" id="editingExpenseId">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">نوع المصروف</label>
                    <select id="expenseType" required class="w-full px-4 py-2 border rounded-lg bg-white">
                        <option value="إيجار">إيجار</option>
                        <option value="رواتب">رواتب</option>
                        <option value="كهرباء/ماء">كهرباء/ماء</option>
                        <option value="بضاعة">بضاعة أخرى</option>
                        <option value="تسويق">تسويق</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <div class="w-1/2">
                        <label class="block text-xs text-gray-500 mb-1">المبلغ</label>
                        <input type="number" id="expenseAmount" required step="0.01" class="w-full px-4 py-2 border rounded-lg font-bold text-red-600">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs text-gray-500 mb-1">التاريخ</label>
                        <input type="date" id="expenseDate" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <textarea id="expenseNote" placeholder="ملاحظات حول المصروف..." class="w-full px-4 py-2 border rounded-lg h-20"></textarea>
                <button type="submit" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition">حفظ المصروف</button>
            </form>
        </div>
    </div>

    <div id="customerDetailsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCustomerModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl w-full max-w-2xl p-0 scale-95 transition-transform max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            
            <div class="bg-gradient-to-l from-indigo-600 to-purple-700 p-6 text-white shrink-0 relative overflow-hidden">
                <button onclick="closeCustomerModal()" class="absolute top-4 left-4 text-white/80 hover:text-white transition bg-white/10 hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="flex items-center gap-4 relative z-10">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-2xl font-bold" id="custModalAvatar">
                        ?
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold" id="custModalName">اسم العميل</h3>
                        <div class="flex gap-3 text-indigo-100 text-sm mt-1">
                            <span id="custModalPhone"><i class="fa-solid fa-phone ml-1"></i> -</span>
                            <span id="custModalEmail"><i class="fa-solid fa-envelope ml-1"></i> -</span>
                        </div>
                    </div>
                </div>
                <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute top-0 right-20 w-20 h-20 bg-white/5 rounded-full blur-xl"></div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase mb-1">إجمالي المشتريات</p>
                        <h4 class="text-xl font-black text-indigo-600" id="custModalTotalSpent">$0</h4>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase mb-1">عدد الطلبات</p>
                        <h4 class="text-xl font-black text-gray-800" id="custModalOrdersCount">0</h4>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase mb-1">متوسط الطلب</p>
                        <h4 class="text-xl font-black text-green-600" id="custModalAvgOrder">$0</h4>
                    </div>
                </div>

                <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-indigo-500"></i> سجل الطلبات
                </h4>
                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 text-gray-500 font-medium">
                            <tr>
                                <th class="px-4 py-3">التاريخ</th>
                                <th class="px-4 py-3">المنتج</th>
                                <th class="px-4 py-3">المبلغ</th>
                                <th class="px-4 py-3">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="custModalOrdersTable" class="divide-y divide-gray-50">
                            </tbody>
                    </table>
                    <div id="custModalNoOrders" class="hidden p-4 text-center text-gray-400 text-sm">لا توجد طلبات لعرضها</div>
                </div>
            </div>
        </div>
    </div>

    <div id="aiResultModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAiModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl w-full max-w-2xl overflow-hidden max-h-[85vh] flex flex-col" id="aiModalContent">
            <div class="bg-indigo-600 p-4 text-white flex justify-between flex-shrink-0"><h3 id="aiModalTitle">AI</h3><button onclick="closeAiModal()">X</button></div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="aiLoading" class="hidden text-center"><div class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto"></div></div>
                <div id="aiResponseText" class="prose prose-sm max-w-none text-right"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, serverTimestamp, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCzS7koqKR_KuSd0iRnHZtl7UqHFOZpcWU",
            authDomain: "salary-e3ae8.firebaseapp.com",
            projectId: "salary-e3ae8",
            storageBucket: "salary-e3ae8.firebasestorage.app",
            messagingSenderId: "335122218048",
            appId: "1:335122218048:web:c2ff2b6ef93c722f2473a5",
            measurementId: "G-TGV2NY90ZF"
        };


        let auth, db;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase init error", e); }


        let orders = [];
        let products = [];
        let expenses = []; 
        let customers = [];
        let chartInstance = null;
        let isLoginMode = true;
        let currentCurrency = 'JOD'; 
        let currentUser = null;
        let unsubscribeOrders = null;
        let unsubscribeProducts = null;
        let unsubscribeExpenses = null; 
        let unsubscribeSettings = null;
        let activeView = 'dashboard'; 


        const currencyRates = {
            'JOD': { rate: 1, symbol: 'د.أ' },
            'USD': { rate: 1.41, symbol: '$' },
            'SYP': { rate: 18000, symbol: 'ل.س' } 
        };


        const authLoading = document.getElementById('auth-loading');
        const loginView = document.getElementById('login-view');
        const appDashboard = document.getElementById('app-dashboard');


        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;

                    subscribeToData(user.uid);
                    showDashboard(user);
                } else {
                    currentUser = null;
                    unsubscribeFromData();
                    showLogin();
                }
                hideLoading();
            });
        } else {
            console.error("Authentication failed to initialize. Checking config...");
            hideLoading();
            showLogin();
        }

        function unsubscribeFromData() {
            if (unsubscribeOrders) unsubscribeOrders();
            if (unsubscribeProducts) unsubscribeProducts();
            if (unsubscribeExpenses) unsubscribeExpenses(); 
            if (unsubscribeSettings) unsubscribeSettings();
            orders = [];
            products = [];
            expenses = [];
        }

        function subscribeToData(userId) {

            const ordersRef = collection(db, `users/${userId}/orders`);
            const qOrders = query(ordersRef, orderBy('date', 'desc'));
            
            unsubscribeOrders = onSnapshot(qOrders, (snapshot) => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(); 
            });

            const productsRef = collection(db, `users/${userId}/products`);
            
            unsubscribeProducts = onSnapshot(productsRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });

            const expensesRef = collection(db, `users/${userId}/expenses`);
            const qExpenses = query(expensesRef, orderBy('date', 'desc'));
            unsubscribeExpenses = onSnapshot(qExpenses, (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });

            const settingsRef = doc(db, `users/${userId}/settings/general`);
            unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.storeName) {
                        document.getElementById('storeNameSidebar').innerText = data.storeName;
                        document.getElementById('storeNameInput').value = data.storeName;
                    }
                    if(data.currency) {
                        currentCurrency = data.currency;
                        document.getElementById('currencySelect').value = data.currency;
                        renderAll(); 
                    }
                }
            });
        }

        document.getElementById('searchInput').addEventListener('input', handleSearch);
        document.getElementById('searchScope').addEventListener('change', handleSearch);

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const scope = document.getElementById('searchScope').value;

            if(query.length > 0) {
                if (scope === 'orders' && activeView !== 'orders') switchView('orders');
                if (scope === 'products' && activeView !== 'products') switchView('products');
                if (scope === 'customers' && activeView !== 'customers') switchView('customers');
            }

            renderAll(); 
        }

        function getFilteredOrders() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const scope = document.getElementById('searchScope').value;
            
            if (scope === 'products' || scope === 'customers') return orders; 
            
            if (!query) return orders;

            return orders.filter(o => 
                (o.id && o.id.toLowerCase().includes(query)) ||
                (o.customer && o.customer.toLowerCase().includes(query)) ||
                (o.product && o.product.toLowerCase().includes(query)) ||
                (o.snapshotDescription && o.snapshotDescription.toLowerCase().includes(query)) 
            );
        }

        function getFilteredProducts() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const scope = document.getElementById('searchScope').value;

            if (scope === 'orders' || scope === 'customers') return products;

            if (!query) return products;

            return products.filter(p => 
                (p.name && p.name.toLowerCase().includes(query)) ||
                (p.category && p.category.toLowerCase().includes(query)) ||
                (p.description && p.description.toLowerCase().includes(query))
            );
        }

        function getFilteredCustomers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const scope = document.getElementById('searchScope').value;
            
            const customersMap = {};

            orders.forEach(o => {
                const name = o.customer || 'غير معروف';
                const email = (o.customerEmail || '').trim().toLowerCase();
                const phone = (o.customerPhone || '').trim();

                const key = `${name}|${email}|${phone}`;

                if (!customersMap[key]) {
                    customersMap[key] = {
                        name: name,
                        email: email || '',
                        phone: phone || '',
                        orders: 0,
                        spent: 0
                    };
                }

                customersMap[key].orders += 1;
                customersMap[key].spent += parseFloat(o.amount || 0);
            });

            let allCustomers = Object.values(customersMap);

            if (scope === 'orders' || scope === 'products') return allCustomers;
            if (!query) return allCustomers;

            return allCustomers.filter(c => 
                (c.name && c.name.toLowerCase().includes(query)) ||
                (c.email && c.email.toLowerCase().includes(query)) ||
                (c.phone && c.phone.includes(query))
            );
        }


        window.formatMoney = (amountInJOD) => {
            if (isNaN(amountInJOD) || amountInJOD === null) return "0 " + currencyRates[currentCurrency].symbol;
            const config = currencyRates[currentCurrency];
            const converted = amountInJOD * config.rate;
            return `${converted.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2})} ${config.symbol}`;
        };

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;

            const newStoreName = document.getElementById('storeNameInput').value;
            const selectedCurrency = document.getElementById('currencySelect').value;
            
            try {
                await setDoc(doc(db, `users/${currentUser.uid}/settings/general`), {
                    storeName: newStoreName,
                    currency: selectedCurrency,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                alert('تم حفظ الإعدادات بنجاح!');
            } catch(error) {
                console.error("Error saving settings:", error);
                alert("حدث خطأ أثناء حفظ الإعدادات");
            }
        });

        window.wipeAllData = async () => {
            if(!currentUser) return;
            
            const confirm1 = confirm("تحذير هام!\n\nهل أنت متأكد تماماً من رغبتك في حذف كافة البيانات؟\n(المنتجات، الطلبات، السجلات)\n\nلا يمكن التراجع عن هذا الإجراء.");
            if(!confirm1) return;
            
            const confirm2 = confirm("تأكيد نهائي: سيتم تصفير النظام بالكامل وحذف كل شيء.");
            if(!confirm2) return;

            try {
                const ordersQuery = await getDocs(collection(db, `users/${currentUser.uid}/orders`));
                const ordersPromises = ordersQuery.docs.map(d => deleteDoc(d.ref));
                
                const productsQuery = await getDocs(collection(db, `users/${currentUser.uid}/products`));
                const productsPromises = productsQuery.docs.map(d => deleteDoc(d.ref));

                const expensesQuery = await getDocs(collection(db, `users/${currentUser.uid}/expenses`));
                const expensesPromises = expensesQuery.docs.map(d => deleteDoc(d.ref));

                await Promise.all([...ordersPromises, ...productsPromises, ...expensesPromises]);
                
                alert("تم تصفير النظام بنجاح.");
                window.location.reload(); 
            } catch (error) {
                console.error("Error wiping data:", error);
                alert("حدث خطأ أثناء عملية الحذف. يرجى المحاولة مرة أخرى.");
            }
        };

        
        window.toggleReportInputs = () => {
            const type = document.querySelector('input[name="reportType"]:checked').value;
            document.getElementById('dayInputGroup').classList.add('hidden');
            document.getElementById('rangeInputGroup').classList.add('hidden');
            
            if(type === 'day') document.getElementById('dayInputGroup').classList.remove('hidden');
            if(type === 'range') document.getElementById('rangeInputGroup').classList.remove('hidden');
        };

        window.generatePDF = () => {
            
            const type = document.querySelector('input[name="reportType"]:checked').value;
            let filteredOrders = orders; 
            let filteredExpenses = expenses;
            let reportTitle = "تقرير مالي شامل";
            const storeName = document.getElementById('storeNameInput').value || "SalesPro Store";

            if (type === 'day') {
                const day = document.getElementById('reportDay').value;
                if(!day) return alert('الرجاء اختيار التاريخ');
                filteredOrders = orders.filter(o => o.date === day);
                filteredExpenses = expenses.filter(e => e.date === day);
                reportTitle = `تقرير يوم: ${day}`;
            } else if (type === 'range') {
                const from = document.getElementById('reportFrom').value;
                const to = document.getElementById('reportTo').value;
                if(!from || !to) return alert('الرجاء اختيار التواريخ');
                filteredOrders = orders.filter(o => o.date >= from && o.date <= to);
                filteredExpenses = expenses.filter(e => e.date >= from && e.date <= to);
                reportTitle = `تقرير الفترة من ${from} إلى ${to}`;
            }

            
            const totalSales = filteredOrders.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
            const grossProfits = filteredOrders.reduce((sum, o) => sum + parseFloat(o.profit || 0), 0);
            const totalExp = filteredExpenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const netProfitFinal = grossProfits - totalExp;

            const printArea = document.getElementById('printable-report');
            
            const orderRows = filteredOrders.map((o, index) => `
                <tr class="border-b border-gray-200">
                    <td class="py-2 px-2 text-right">${index + 1}</td>
                    <td class="py-2 px-2 text-right font-bold">${o.customer}</td>
                    <td class="py-2 px-2 text-right">${o.product}</td>
                    <td class="py-2 px-2 text-center">${o.quantity || 1}</td>
                    <td class="py-2 px-2 text-right">${formatMoney(parseFloat(o.amount))}</td>
                    <td class="py-2 px-2 text-right text-green-600 font-bold">${formatMoney(parseFloat(o.profit))}</td>
                </tr>
            `).join('');

            const expenseRows = filteredExpenses.map(e => `
                <tr class="border-b border-red-100 bg-red-50/20">
                    <td class="py-2 px-2 text-right font-bold text-red-600">${e.type}</td>
                    <td class="py-2 px-2 text-right italic text-gray-500">${e.note || '-'}</td>
                    <td class="py-2 px-2 text-right font-bold text-red-700">${formatMoney(parseFloat(e.amount))}</td>
                </tr>
            `).join('');

            const template = `
                <div class="p-10 bg-white" style="direction: rtl;">
                    <div class="text-center border-b-4 border-indigo-600 pb-4 mb-8">
                        <h1 class="text-3xl font-black">${storeName}</h1>
                        <p class="text-gray-500">${reportTitle}</p>
                    </div>

                    <div class="grid grid-cols-4 gap-4 mb-8">
                        <div class="border p-4 rounded text-center">
                            <p class="text-xs text-gray-500">إجمالي المبيعات</p>
                            <h2 class="text-xl font-bold">${formatMoney(totalSales)}</h2>
                        </div>
                        <div class="border p-4 rounded text-center">
                            <p class="text-xs text-gray-500">أرباح البضاعة</p>
                            <h2 class="text-xl font-bold text-indigo-600">${formatMoney(grossProfits)}</h2>
                        </div>
                        <div class="border p-4 rounded text-center bg-red-50">
                            <p class="text-xs text-red-500">إجمالي المصاريف</p>
                            <h2 class="text-xl font-bold text-red-600">${formatMoney(totalExp)}</h2>
                        </div>
                        <div class="border p-4 rounded text-center bg-orange-50 ring-2 ring-orange-200">
                            <p class="text-xs text-orange-600 font-bold">صافي الربح النهائي</p>
                            <h2 class="text-xl font-black">${formatMoney(netProfitFinal)}</h2>
                        </div>
                    </div>

                    <h3 class="font-bold border-r-4 border-indigo-600 pr-2 mb-4">سجل الطلبات</h3>
                    <table class="w-full text-sm mb-8 border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-right">#</th><th class="p-2 text-right">العميل</th><th class="p-2 text-right">المنتج</th><th class="p-2 text-center">الكمية</th><th class="p-2 text-right">المبلغ</th><th class="p-2 text-right">الربح</th>
                            </tr>
                        </thead>
                        <tbody>${orderRows}</tbody>
                    </table>

                    <h3 class="font-bold border-r-4 border-red-600 pr-2 mb-4">سجل المصروفات</h3>
                    <table class="w-full text-sm border">
                        <thead class="bg-red-50">
                            <tr><th class="p-2 text-right">نوع المصروف</th><th class="p-2 text-right">ملاحظات</th><th class="p-2 text-right">المبلغ</th></tr>
                        </thead>
                        <tbody>${expenseRows || '<tr><td colspan="3" class="text-center p-4">لا توجد مصاريف</td></tr>'}</tbody>
                    </table>
                </div>
            `;

            printArea.innerHTML = template;
            setTimeout(() => window.print(), 500); 
        };


        document.getElementById('toggleAuthMode').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authError').classList.add('hidden');
            if(isLoginMode) {
                document.getElementById('authTitle').innerText = "تسجيل الدخول";
                document.getElementById('submitBtn').innerText = "دخول";
            } else {
                
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            try {
                if (isLoginMode) await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                const errDiv = document.getElementById('authError');
                errDiv.innerText = error.message; 
                errDiv.classList.remove('hidden');
            }
        });

        document.getElementById('demoLoginBtn').addEventListener('click', async () => {
             try { await signInAnonymously(auth); } catch(e) { console.error(e); }
        });

        window.logoutUser = async () => await signOut(auth);

        function hideLoading() {
            authLoading.style.opacity = '0';
            setTimeout(() => { authLoading.classList.add('hidden'); authLoading.style.display = 'none'; }, 500);
        }

        function showDashboard(user) {
            loginView.classList.add('hidden');
            appDashboard.classList.remove('hidden');
            setTimeout(() => appDashboard.classList.remove('opacity-0'), 50);
            
            const displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'زائر');
            document.getElementById('userNameDisplay').innerText = displayName;
            document.getElementById('userEmailDisplay').innerText = user.email || 'حساب تجريبي';
            document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${displayName}&background=6366f1&color=fff`;
        }

        function showLogin() {
            appDashboard.classList.add('hidden', 'opacity-0');
            loginView.classList.remove('hidden');
        }

        function renderAll() {
            renderStats();
            renderOrdersTable();
            renderProductsTable();
            renderExpensesTable(); 
            renderCustomers();
            initChart();
            updateProductDropdown();
        }

        function updateProductDropdown() {
            const select = document.getElementById('productNameSelect');
            if (products.length === 0) {
                 select.innerHTML = '<option value="" disabled selected>لا توجد منتجات، أضف منتجاً أولاً</option>';
            } else {
                 let options = '<option value="" disabled selected>اختر منتجاً...</option>';
                 
                 options += products.map(p => `<option value="${p.name}" data-price="${p.price}" data-desc="${p.description || ''}">${p.name} (المتوفر: ${p.stock})</option>`).join('');
                 select.innerHTML = options;
            }
        }

        function updateOrderCalculations() {
            const select = document.getElementById('productNameSelect');
            const quantityInput = document.getElementById('orderQuantity');
            
            if(select.selectedIndex === -1) return;
            
            const selectedOption = select.options[select.selectedIndex];
            if(!selectedOption) return;

            const unitPrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;
            const desc = selectedOption.getAttribute('data-desc');
            const qty = parseInt(quantityInput.value) || 1;

            const total = unitPrice * qty;
            document.getElementById('orderAmount').value = total;

            const descDiv = document.getElementById('selectedProductDesc');
            if (desc) {
                descDiv.innerText = "تفاصيل المنتج: " + desc;
                descDiv.classList.remove('hidden');
            } else {
                descDiv.classList.add('hidden');
            }
        }

        document.getElementById('productNameSelect').addEventListener('change', updateOrderCalculations);
        document.getElementById('orderQuantity').addEventListener('input', updateOrderCalculations);


        function renderStats() {
            const totalSalesValue = orders.reduce((sum, order) => sum + parseFloat(order.amount || 0), 0);
            const grossProfitsValue = orders.reduce((sum, order) => sum + parseFloat(order.profit || 0), 0);
            const totalExpValue = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
            
            const netProfitValue = grossProfitsValue - totalExpValue;

            document.getElementById('totalSales').innerText = formatMoney(totalSalesValue);
            document.getElementById('grossProfits').innerText = formatMoney(grossProfitsValue);
            document.getElementById('totalExpenses').innerText = formatMoney(totalExpValue);
            document.getElementById('totalProfits').innerText = formatMoney(netProfitValue);
            
            const uniqueCustomerKeys = new Set(orders.map(o => `${o.customer}|${(o.customerEmail || '').trim().toLowerCase()}|${(o.customerPhone || '').trim()}`));
            document.getElementById('totalCustomers').innerText = uniqueCustomerKeys.size; 
        }

        function renderOrdersTable() {
            const filteredData = getFilteredOrders();
            const rows = filteredData.map((order, index) => {
                let descToShow = order.snapshotDescription;
                if (!descToShow) {
                    const linkedProduct = products.find(p => p.name === order.product);
                    descToShow = linkedProduct ? linkedProduct.description : '';
                }
                const displayDesc = descToShow ? descToShow.substring(0, 50) + (descToShow.length > 50 ? '...' : '') : '-';
                const qty = order.quantity || 1;

                return `
                <tr class="hover:bg-gray-50 border-b border-gray-50 last:border-0 group">
                    <td class="px-3 sm:px-6 py-4 font-bold text-gray-700">${order.id.substring(0, 8)}</td>
                    <td class="px-3 sm:px-6 py-4">${order.customer}</td>
                    <td class="px-3 sm:px-6 py-4 text-gray-600 text-xs font-mono">${order.customerPhone || '-'}</td> <td class="px-3 sm:px-6 py-4">
                        <div class="font-bold text-gray-800">${order.product}</div>
                        <div class="text-xs text-gray-400 mt-1">${displayDesc}</div>
                    </td>
                    <td class="px-3 sm:px-6 py-4 text-center font-bold text-gray-600 bg-gray-50 rounded-lg mx-2">${qty}</td>
                    <td class="px-3 sm:px-6 py-4 text-xs text-gray-500">${order.date}</td>
                    <td class="px-3 sm:px-6 py-4 font-bold">${formatMoney(parseFloat(order.amount))}</td>
                    <td class="px-3 sm:px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${getStatusClass(order.status)}">${getStatusText(order.status)}</span></td>
                    <td class="px-3 sm:px-6 py-4 flex gap-2 items-center">
                        ${order.status === 'pending' ? 
                            `<button onclick="quickCompleteOrder('${order.id}')" class="text-green-500 hover:text-green-700 bg-green-50 p-1.5 rounded-full transition" title="إكمال"><i class="fa-solid fa-check"></i></button>` 
                            : ''}
                        <button onclick="editOrder('${order.id}')" class="text-blue-500 hover:text-blue-700" title="تعديل"><i class="fa-solid fa-pen"></i></button>
                    </td>
                </tr>
            `}).join('');

            const dashboardBody = document.getElementById('dashboardOrdersTableBody');
            const allOrdersBody = document.getElementById('allOrdersTableBody');
            const noDataMsg = document.getElementById('noDataMessage');

            if (filteredData.length === 0) {
                if(dashboardBody) dashboardBody.innerHTML = '';
                if(allOrdersBody) allOrdersBody.innerHTML = '';
                if(noDataMsg) noDataMsg.classList.remove('hidden');
            } else {
                if(dashboardBody) dashboardBody.innerHTML = rows;
                if(allOrdersBody) allOrdersBody.innerHTML = rows;
                if(noDataMsg) noDataMsg.classList.add('hidden');
            }
        }

        function renderExpensesTable() {
            const tableBody = document.getElementById('expensesTableBody');
            if(!tableBody) return;
            tableBody.innerHTML = expenses.map(e => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-bold">${e.type}</td>
                    <td class="px-6 py-4 text-red-600 font-bold">${formatMoney(parseFloat(e.amount))}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${e.date}</td>
                    <td class="px-6 py-4 text-xs text-gray-400 italic">${e.note || '-'}</td>
                    <td class="px-6 py-4 flex gap-2">
                        <button onclick="editExpense('${e.id}')" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteExpense('${e.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center py-10 text-gray-400">لا توجد مصروفات مسجلة</td></tr>';
        }

        window.openExpenseModal = (id = null) => {
            document.getElementById('addExpenseModal').classList.remove('hidden');
            document.getElementById('expenseForm').reset();
            document.getElementById('editingExpenseId').value = "";
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            if(id) {
                const exp = expenses.find(e => e.id === id);
                if(exp) {
                    document.getElementById('expenseModalTitle').innerText = "تعديل المصروف";
                    document.getElementById('editingExpenseId').value = id;
                    document.getElementById('expenseType').value = exp.type;
                    document.getElementById('expenseAmount').value = exp.amount;
                    document.getElementById('expenseDate').value = exp.date;
                    document.getElementById('expenseNote').value = exp.note || '';
                }
            } else {
                document.getElementById('expenseModalTitle').innerText = "إضافة مصروف جديد";
            }
        }

        window.closeExpenseModal = () => document.getElementById('addExpenseModal').classList.add('hidden');

        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const id = document.getElementById('editingExpenseId').value;
            const data = {
                type: document.getElementById('expenseType').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                date: document.getElementById('expenseDate').value,
                note: document.getElementById('expenseNote').value,
                updatedAt: serverTimestamp()
            };
            try {
                if(id) await updateDoc(doc(db, `users/${currentUser.uid}/expenses`, id), data);
                else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `users/${currentUser.uid}/expenses`), data);
                }
                closeExpenseModal();
            } catch(err) { console.error(err); alert("خطأ في الحفظ"); }
        });

        window.deleteExpense = async (id) => {
            if(confirm('هل تريد حذف هذا المصروف؟')) {
                try { await deleteDoc(doc(db, `users/${currentUser.uid}/expenses`, id)); } 
                catch(err) { console.error(err); }
            }
        }

        window.quickCompleteOrder = async (id) => {
            if(!currentUser) return;
            const orderRef = doc(db, `users/${currentUser.uid}/orders`, id);
            try {
                await updateDoc(orderRef, { status: 'completed' });
            } catch (e) {
                console.error("Error updating order:", e);
                alert("حدث خطأ أثناء تحديث الطلب");
            }
        };

        function renderProductsTable() {
            const filteredData = getFilteredProducts();
            const rows = filteredData.map((p, index) => {
                const stockClass = p.stock === 0 ? 'text-red-600 font-bold' : (p.stock < 10 ? 'text-orange-500 font-bold' : 'text-gray-700');
                const profit = parseFloat(p.price) - parseFloat(p.cost || 0);

                return `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-3 sm:px-6 py-4 font-bold">${p.name}</td>
                    <td class="px-3 sm:px-6 py-4 text-xs text-gray-500 max-w-xs truncate" title="${p.description || ''}">${p.description || '-'}</td>
                    <td class="px-3 sm:px-6 py-4">${p.category}</td>
                    <td class="px-3 sm:px-6 py-4">${formatMoney(parseFloat(p.price))}</td>
                    <td class="px-3 sm:px-6 py-4 text-gray-500">${formatMoney(parseFloat(p.cost || 0))}</td>
                    <td class="px-3 sm:px-6 py-4 text-green-600 font-bold">${formatMoney(profit)}</td> <td class="px-3 sm:px-6 py-4 ${stockClass}">${p.stock}</td>
                    <td class="px-3 sm:px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${p.status}</span></td>
                    <td class="px-3 sm:px-6 py-4 flex gap-2">
                        <button onclick="editProduct('${p.id}')" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700 text-sm"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
            
            const tbody = document.getElementById('productsTableBody');
            if(tbody) tbody.innerHTML = rows || '<tr><td colspan="8" class="text-center py-4 text-gray-400">لا توجد منتجات مطابقة</td></tr>';
            
            const topContainer = document.getElementById('topProductsContainer');
            if(topContainer) {
                 const salesCounts = {};
                 orders.forEach(o => {
                     if(o.status !== 'cancelled') {
                        const qty = parseInt(o.quantity) || 0;
                        salesCounts[o.product] = (salesCounts[o.product] || 0) + qty;
                     }
                 });

                 const rankedProducts = [...products].sort((a, b) => {
                     const soldA = salesCounts[a.name] || 0;
                     const soldB = salesCounts[b.name] || 0;
                     return soldB - soldA; // Descending order
                 });

                 topContainer.innerHTML = rankedProducts.slice(0,3).map(p => {
                    const soldCount = salesCounts[p.name] || 0;
                    return `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-indigo-500"><i class="fa-solid fa-box"></i></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold">${p.name}</h4>
                            <p class="text-xs text-gray-500">${p.category} <span class="text-indigo-600 font-bold mx-1">(${soldCount} مباع)</span></p>
                        </div>
                        <div class="font-bold">${formatMoney(parseFloat(p.price))}</div>
                    </div>
                 `}).join('') || '<div class="text-gray-400 text-center text-sm">لا توجد مبيعات كافية لعرض البيانات</div>';
            }
        }

        function renderCustomers() {
            const customersToRender = getFilteredCustomers();
            const grid = document.getElementById('customersGrid');
            if(!grid) return;
            if(customersToRender.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10">لا يوجد عملاء مطابقين للبحث</div>';
                return;
            }
            grid.innerHTML = customersToRender.map(c => {
                const encodedInfo = encodeURIComponent(JSON.stringify({name: c.name, email: c.email, phone: c.phone}));
                
                return `
                <div onclick="openCustomerDetails('${encodedInfo}')" class="bg-white p-6 rounded-2xl shadow-sm border text-center hover:shadow-md hover:border-indigo-300 transition cursor-pointer group relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-400 to-purple-500 opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 font-bold text-lg group-hover:bg-indigo-600 group-hover:text-white transition">${c.name.charAt(0)}</div>
                    <h3 class="font-bold text-gray-800 group-hover:text-indigo-700 transition">${c.name}</h3>
                    <p class="text-xs text-gray-500 mt-1">${c.email || '-'}</p>
                    <p class="text-xs text-gray-500 mb-4">${c.phone || '-'}</p>
                    <div class="flex justify-between border-t pt-2 text-xs">
                        <div><span>الطلبات: </span><b>${c.orders}</b></div>
                        <div><span>مجموع: </span><b class="text-green-600">${formatMoney(c.spent)}</b></div>
                    </div>
                    <div class="absolute top-2 left-2 text-xs text-indigo-400 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-eye"></i> عرض التفاصيل</div>
                </div>
            `}).join('');
        }
        
        window.openCustomerDetails = (encodedInfo) => {
             const info = JSON.parse(decodeURIComponent(encodedInfo));
             
             document.getElementById('custModalName').innerText = info.name;
             document.getElementById('custModalAvatar').innerText = info.name.charAt(0);
             document.getElementById('custModalEmail').innerHTML = `<i class="fa-solid fa-envelope ml-1"></i> ${info.email || 'غير متوفر'}`;
             document.getElementById('custModalPhone').innerHTML = `<i class="fa-solid fa-phone ml-1"></i> ${info.phone || 'غير متوفر'}`;
             
             const customerOrders = orders.filter(o => {
                 const oName = o.customer;
                 const oEmail = (o.customerEmail || '').trim().toLowerCase();
                 const oPhone = (o.customerPhone || '').trim();
                 return oName === info.name && oEmail === (info.email || '') && oPhone === (info.phone || '');
             });

             const totalSpent = customerOrders.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
             const count = customerOrders.length;
             const avgOrder = count > 0 ? totalSpent / count : 0;
             
             document.getElementById('custModalTotalSpent').innerText = formatMoney(totalSpent);
             document.getElementById('custModalOrdersCount').innerText = count;
             document.getElementById('custModalAvgOrder').innerText = formatMoney(avgOrder);

             const tableBody = document.getElementById('custModalOrdersTable');
             const noOrdersMsg = document.getElementById('custModalNoOrders');
             
             if(count === 0) {
                 tableBody.innerHTML = '';
                 noOrdersMsg.classList.remove('hidden');
             } else {
                 noOrdersMsg.classList.add('hidden');
                 tableBody.innerHTML = customerOrders.map(o => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-gray-600">${o.date}</td>
                        <td class="px-4 py-3 font-bold text-gray-800">${o.product}</td>
                        <td class="px-4 py-3 text-indigo-600 font-bold">${formatMoney(parseFloat(o.amount))}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${getStatusClass(o.status)}">${getStatusText(o.status)}</span></td>
                    </tr>
                 `).join('');
             }

             document.getElementById('customerDetailsModal').classList.remove('hidden');
        };

        window.closeCustomerModal = () => document.getElementById('customerDetailsModal').classList.add('hidden');

        function getStatusClass(status) {
            return status === 'completed' ? 'bg-green-100 text-green-700' : (status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');
        }
        function getStatusText(status) {
            return status === 'completed' ? 'مكتمل' : (status === 'pending' ? 'قيد الانتظار' : 'ملغي');
        }

        // --- Chart ---
        function initChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();
            
            const days = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const arabicDays = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
            const dataPoints = [0,0,0,0,0,0,0];
            
            if(orders.length > 0) {
                 const total = orders.reduce((s,o) => s + parseFloat(o.amount || 0), 0);
                 const config = currencyRates[currentCurrency];
                 const convertedTotal = total * config.rate;
                 dataPoints.fill(convertedTotal / 7); 
            }

            chartInstance = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: arabicDays,
                    datasets: [{
                        label: `المبيعات (${currencyRates[currentCurrency].symbol})`,
                        data: dataPoints,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }

        window.switchView = function(viewName) {
            activeView = viewName; 
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const active = document.getElementById(`nav-${viewName}`);
            if(active) active.classList.add('active');
            if (window.innerWidth < 768) { 
                document.getElementById('sidebar').classList.add('hidden'); 
                document.getElementById('sidebarOverlay').classList.add('hidden'); 
            }
            
            // Set Page Title
            const titles = {
                'dashboard': 'نظرة عامة',
                'products': 'إدارة المنتجات',
                'orders': 'سجل الطلبات',
                'customers': 'قاعدة العملاء',
                'expenses': 'إدارة المصروفات',
                'reports': 'التقارير المالية',
                'settings': 'الإعدادات'
            };
            document.getElementById('pageTitle').innerText = titles[viewName] || 'SalesPro';
            
            renderAll(); 
        };

        window.openProductModal = (id = null) => {
             document.getElementById('addProductModal').classList.remove('hidden');
             document.getElementById('productModalContent').classList.remove('scale-95');
             document.getElementById('productForm').reset();
             document.getElementById('editingProductId').value = "";
             document.getElementById('newProdDesc').value = ""; 

             if (id) {
                 const product = products.find(p => p.id === id);
                 if (product) {
                     document.getElementById('productModalTitle').innerText = "تعديل المنتج";
                     document.getElementById('editingProductId').value = id;
                     document.getElementById('newProdName').value = product.name;
                     document.getElementById('newProdDesc').value = product.description || ''; 
                     document.getElementById('newProdCategory').value = product.category;
                     document.getElementById('newProdPrice').value = product.price;
                     document.getElementById('newProdCost').value = product.cost || 0;
                     document.getElementById('newProdStock').value = product.stock;
                 }
             } else {
                 document.getElementById('productModalTitle').innerText = "إضافة منتج جديد";
             }
        };

        window.editProduct = (id) => window.openProductModal(id);
        window.closeProductModal = () => document.getElementById('addProductModal').classList.add('hidden');

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const editingId = document.getElementById('editingProductId').value;

            const newProd = {
                name: document.getElementById('newProdName').value,
                description: document.getElementById('newProdDesc').value, 
                category: document.getElementById('newProdCategory').value,
                price: parseFloat(document.getElementById('newProdPrice').value),
                cost: parseFloat(document.getElementById('newProdCost').value),
                stock: parseInt(document.getElementById('newProdStock').value),
                status: parseInt(document.getElementById('newProdStock').value) > 0 ? 'متوفر' : 'نفذت',
                updatedAt: serverTimestamp()
            };

            try {
                if (editingId) await updateDoc(doc(db, `users/${currentUser.uid}/products`, editingId), newProd);
                else {
                    newProd.createdAt = serverTimestamp();
                    await addDoc(collection(db, `users/${currentUser.uid}/products`), newProd);
                }
                closeProductModal();
            } catch (e) { console.error(e); alert("خطأ في الحفظ"); }
        });

        window.deleteProduct = async (id) => {
            if(!currentUser) return;
            if(confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                try { await deleteDoc(doc(db, `users/${currentUser.uid}/products`, id)); } catch (e) { console.error(e); }
            }
        };

        window.openOrderModal = (id = null) => {
            if (id === null && products.length === 0) {
                alert("لا يمكن إنشاء طلب جديد لعدم وجود منتجات.");
                return;
            }

            document.getElementById('addOrderModal').classList.remove('hidden');
            document.getElementById('orderForm').reset();
            document.getElementById('orderDate').valueAsDate = new Date();

            if (id !== null && typeof id === 'string') {
                const order = orders.find(o => o.id === id);
                if(order) {
                    document.getElementById('orderModalTitle').innerText = "تعديل الطلب";
                    document.getElementById('editingOrderId').value = id; 
                    document.getElementById('customerName').value = order.customer;
                    document.getElementById('customerEmail').value = order.customerEmail || '';
                    document.getElementById('customerPhone').value = order.customerPhone || '';
                    document.getElementById('productNameSelect').value = order.product;
                    document.getElementById('orderQuantity').value = order.quantity || 1;
                    document.getElementById('orderAmount').value = order.amount;
                    document.getElementById('orderStatus').value = order.status;
                    document.getElementById('orderDate').value = order.date;
                    document.getElementById('orderDescription').value = order.description || '';
                    updateOrderCalculations();
                }
            } else {
                document.getElementById('orderModalTitle').innerText = "إضافة طلب جديد";
                document.getElementById('editingOrderId').value = "";
            }
        };
        
        window.editOrder = (id) => window.openOrderModal(id);
        window.closeOrderModal = () => document.getElementById('addOrderModal').classList.add('hidden');

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            
            const editingId = document.getElementById('editingOrderId').value;
            const productVal = document.getElementById('productNameSelect').value;
            const quantity = parseInt(document.getElementById('orderQuantity').value);
            const amount = parseFloat(document.getElementById('orderAmount').value);
            
            const selectedProduct = products.find(p => p.name === productVal);
            if (!selectedProduct) return alert("المنتج غير موجود");

            if (!editingId && selectedProduct.stock < quantity) {
                return alert(`الكمية غير متوفرة. المتاح: ${selectedProduct.stock}`);
            }

            const profit = amount - ((selectedProduct.cost || 0) * quantity);
            
            const orderData = {
                customer: document.getElementById('customerName').value,
                customerEmail: document.getElementById('customerEmail').value,
                customerPhone: document.getElementById('customerPhone').value,
                product: productVal,
                quantity: quantity, 
                snapshotDescription: selectedProduct.description || '',
                amount: amount,
                profit: profit,
                status: document.getElementById('orderStatus').value,
                date: document.getElementById('orderDate').value,
                description: document.getElementById('orderDescription').value,
                updatedAt: serverTimestamp()
            };

            try {
                if (editingId) await updateDoc(doc(db, `users/${currentUser.uid}/orders`, editingId), orderData);
                else {
                    orderData.createdAt = serverTimestamp();
                    await addDoc(collection(db, `users/${currentUser.uid}/orders`), orderData);
                    const newStock = selectedProduct.stock - quantity;
                    await updateDoc(doc(db, `users/${currentUser.uid}/products`, selectedProduct.id), { stock: newStock, status: newStock > 0 ? 'متوفر' : 'نفذت' });
                }
                closeOrderModal();
                switchView('dashboard');
            } catch (e) { console.error(e); }
        });

        window.editExpense = (id) => window.openExpenseModal(id);

        window.generateDashboardInsights = async () => {
             const sales = document.getElementById('totalSales').innerText;
             const profits = document.getElementById('totalProfits').innerText;
             const expenses = document.getElementById('totalExpenses').innerText;

             const prompt = `
                أنت مستشار مالي ذكي لنظام SalesPro. حلل العلاقة بين الأرقام التالية بدقة:
                - الدخل (المبيعات): ${sales}
                - المصروفات (التكاليف التشغيلية): ${expenses}
                - صافي الربح (النتيجة النهائية): ${profits}

                قواعد الرد (مهم جداً):
                1. (حالة الصفر): إذا كانت كل الأرقام 0، قل فقط: "أهلاً بك! ابدأ بتسجيل المبيعات والمصاريف وسأقوم بتحليل كفاءتك المالية فوراً."
                2. (تحليل المصاريف):
                   - قارن المصاريف مع المبيعات. إذا كانت المصاريف تلتهم أكثر من 50% من المبيعات، حذر المستخدم فوراً واكتب: "⚠️ تنبيه: مصاريفك التشغيلية مرتفعة جداً مقارنة بالمبيعات وتؤثر على صافي ربحك."
                   - إذا كانت المبيعات عالية والربح قليل بسبب المصاريف، وضح له ذلك بصراحة.
                   - إذا كانت الأرباح عالية والمصاريف منخفضة، هنئه على "الكفاءة التشغيلية".
                3. اجعل الرد مختصراً جداً (أقل من 60 كلمة) ومباشراً في صلب الموضوع.
             `;
             
             await callGeminiUI(prompt, "تحليل الأداء والمصاريف", true);
        };

        // --- New Functions for Auto-Generating Details ---

        window.generateProductDescAI = async () => {
            const name = document.getElementById('newProdName').value;
            const category = document.getElementById('newProdCategory').value;
            const targetField = document.getElementById('newProdDesc');

            if(!name) return alert('الرجاء كتابة اسم المنتج أولاً!');

            const prompt = `اكتب وصفاً تسويقياً جذاباً ومختصراً (لا يتجاوز سطرين) لمنتج اسمه "${name}" يندرج تحت تصنيف "${category || 'عام'}". ركز على المميزات والفوائد.`;
            
            await generateTextForField(prompt, targetField);
        };

        window.generateOrderNoteAI = async () => {
            const customer = document.getElementById('customerName').value;
            const product = document.getElementById('productNameSelect').value;
            const targetField = document.getElementById('orderDescription');

            if(!customer || !product) return alert('الرجاء اختيار العميل والمنتج أولاً!');

            const prompt = `اكتب ملاحظة رسمية مهنية قصيرة جداً (سطر واحد) تضاف لفاتورة العميل "${customer}" الذي اشترى منتج "${product}". اشكره وتمنى له التوفيق.`;

            await generateTextForField(prompt, targetField);
        };

        // Helper function for inline generation
        async function generateTextForField(prompt, targetElement) {
            // Show loading state on the button itself if possible, or simple placeholder
            const originalPlaceholder = targetElement.placeholder;
            targetElement.placeholder = "جاري التوليد بالذكاء الاصطناعي... ⏳";
            targetElement.disabled = true;

            try {
                const apiKey = "AIzaSyAQhplJ0Ez0zHMr2AYg-UK6w033ZhEzfmY"; 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) {
                    console.error(data.error);
                    alert("خطأ AI: " + data.error.message);
                } else {
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    targetElement.value = text.trim();
                }
            } catch (e) {
                console.error(e);
                alert("فشل الاتصال");
            } finally {
                targetElement.placeholder = originalPlaceholder;
                targetElement.disabled = false;
            }
        }
        
        async function callGeminiUI(prompt, title, showModal = true) {
            if(showModal) {
                const modal = document.getElementById('aiResultModal');
                document.getElementById('aiModalTitle').innerText = title;
                document.getElementById('aiResponseText').innerHTML = '';
                document.getElementById('aiLoading').classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            try {
                const apiKey = "AIzaSyBlnWFnSBPKQ6xTJpc7cB2QIy7X_r5VAOQ"; 
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();

                if (data.error) {
                    const msg = "خطأ في التصريح: " + data.error.message;
                    if(showModal) document.getElementById('aiResponseText').innerText = msg;
                    return msg;
                } else {
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "لا توجد إجابة";
                    if(showModal) document.getElementById('aiResponseText').innerHTML = marked.parse(text);
                    return text;
                }

            } catch (e) {
                console.error(e);
                if(showModal) document.getElementById('aiResponseText').innerText = "فشل الاتصال بالخدمة";
            } finally {
                if(showModal) document.getElementById('aiLoading').classList.add('hidden');
            }
        }

        window.closeAiModal = () => document.getElementById('aiResultModal').classList.add('hidden');
        
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('hidden', 'translate-x-full');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        });
        document.getElementById('sidebarOverlay')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('hidden', 'translate-x-full');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        });
        
        document.getElementById('reportDay').valueAsDate = new Date();
    </script>
</body>
</html>

